<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>People Relationships (Undirected)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- D3 core + chromatic scales -->
  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script src="https://unpkg.com/d3-scale-chromatic@3/dist/d3-scale-chromatic.min.js"></script>

  <!-- ===== THEME TOKENS: Change these to restyle the whole page ===== -->
  <style>
    :root{
      /* Typography */
      --font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --font-size-base: 20px;            /* Global body text size */
      --font-size-h1: 22px;              /* Banner title */
      --font-size-legend: 14px;          /* Legend + controls text */
      --font-size-node: 14px;            /* Names under nodes */
      --font-size-link-label: 12px;      /* Relationship label on edges */
      --font-size-tooltip: 14px;         /* Tooltip body text */
      --font-size-tooltip-title: 16px;   /* Tooltip title */

      /* Colors */
      --color-bg: #0f172a;               /* Page background */
      --color-panel: #111827;            /* Card/panel background */
      --color-ink: #e5e7eb;              /* Primary text color */
      --color-muted: #9ca3af;            /* Muted text */
      --color-graph-bg: #0b1220;         /* Graph area background */
      --color-node-stroke: #cbd5e1;      /* Node border */
      --color-link-label: #e5e7eb;       /* Edge label text */
      --color-tooltip-bg: #111827;       /* Tooltip bg */
      --color-tooltip-text: #e5e7eb;     /* Tooltip text */
      --color-border: #1f2937;           /* Panel borders */

      /* Relationship palette (legend colors for edge types) */
      --rel-1: #60a5fa;  /* blue */
      --rel-2: #34d399;  /* green */
      --rel-3: #f472b6;  /* pink */
      --rel-4: #f59e0b;  /* amber */
      --rel-5: #a78bfa;  /* violet */
      --rel-6: #fca5a5;  /* red-200 */
      --rel-7: #93c5fd;  /* blue-200 */
    }

    /* ===== Base layout (uses tokens above) ===== */
    html, body{
      margin:0; padding:0;
      background: var(--color-bg);
      color: var(--color-ink);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
    }
    header{ padding:16px 20px; }
    h1{
      margin:0 0 6px;
      font-size: var(--font-size-h1);
    }
    .wrap{ padding:0 20px 24px; }
    .panel{
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.25);
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      color: var(--color-ink);
      font-size: var(--font-size-legend);
      margin-bottom:10px;
    }
    .hint{ color:var(--color-muted); font-size: var(--font-size-legend); }
    input[type="file"]{ color: var(--color-ink); }

    .legend{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .key{ display:inline-flex; align-items:center; gap:8px; font-size: var(--font-size-legend); color:var(--color-muted); }
    .swatch{ width:14px; height:14px; border-radius:4px; display:inline-block; border:1px solid rgba(255,255,255,.2) }

    #graph{ width:100%; aspect-ratio: 16/9; background: var(--color-graph-bg); border-radius: 8px; }

    .link{ stroke-width:2px; opacity:0.85; }
    .link-label{
      font-size: var(--font-size-link-label);
      fill: var(--color-link-label);
      pointer-events:none;
      text-shadow: 0 1px 3px rgba(0,0,0,.7);
    }

    /* No fixed circle radius; color and size are data-driven in JS */
    .node text{
      font-size: var(--font-size-node);
      fill: var(--color-ink);
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
      pointer-events: none;
    }
    .node circle{
      /* fill set in JS to degree color scale */
      stroke: var(--color-node-stroke);
      stroke-width:1.5px;
    }
    .node:hover circle, .node--active circle{ stroke-width:2.5px; }
    .link--dim{ opacity:0.18 !important; }
    .node--dim{ opacity:0.25 !important; }

    .tooltip{
      position:absolute; pointer-events:none;
      background: var(--color-tooltip-bg);
      color: var(--color-tooltip-text);
      border:1px solid var(--color-border);
      border-radius:10px;
      padding:10px 12px;
      font-size: var(--font-size-tooltip);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      z-index:10; max-width:320px;
    }
    .tooltip h3{
      margin:0 0 6px 0;
      font-size: var(--font-size-tooltip-title);
      color:#fff;
    }
    .tooltip .row{ display:flex; gap:8px; align-items:flex-start; }
    .tooltip img{
      width:56px; height:56px; border-radius:8px; object-fit:cover; border:1px solid var(--color-border);
    }
    .tooltip .meta{ color:#cbd5e1; line-height:1.35; }
    .tooltip .meta a{ color:#93c5fd; text-decoration:none; }

    /* Small style panel (optional) */
    .style-panel{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin: 8px 0 2px;
      font-size: var(--font-size-legend);
    }
    .style-panel label{ color:var(--color-muted); }
    .style-panel input, .style-panel select{ background:#0b1220; color:var(--color-ink); border:1px solid var(--color-border); border-radius:6px; padding:4px 6px; }
  </style>
</head>

<body>
  <header>
    <h1>People Relationships (Undirected)</h1>
    <!-- OPTIONAL live style controls (remove if you don’t want it) -->
    <div class="wrap">
      <div class="panel">
        <div class="style-panel" id="stylePanel">
          <label>Base font
            <input id="baseSize" type="number" value="20" min="10" max="28" style="width:64px"> px
          </label>
          <label>Node text
            <input id="nodeSize" type="number" value="14" min="10" max="28" style="width:64px"> px
          </label>
          <label>Tooltip text
            <input id="tipSize" type="number" value="14" min="10" max="28" style="width:64px"> px
          </label>
          <label>Font family
            <select id="fontFamily">
              <option value='system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif'>System</option>
              <option value='"Helvetica Neue", Helvetica, Arial, sans-serif'>Helvetica</option>
              <option value='"Times New Roman", Times, serif'>Times</option>
              <option value='"Georgia", serif'>Georgia</option>
              <option value='"Courier New", Courier, monospace'>Courier</option>
            </select>
          </label>
          <label>Page bg <input id="bgColor" type="color" value="#0f172a"></label>
          <label>Text color <input id="inkColor" type="color" value="#e5e7eb"></label>
        </div>
        <div class="controls">
          <strong>Auto-load:</strong>
          <span id="statusR" class="hint">relationships.csv</span>,
          <span id="statusP" class="hint">people.csv</span>
          <span class="hint">• Serve folder (e.g. <code>python -m http.server</code>) for automatic loading.</span>
        </div>
        <div class="controls">
          <strong>Or pick files:</strong>
          <label>Edges <input id="fileR" type="file" accept=".csv" /></label>
          <label>People <input id="fileP" type="file" accept=".csv" /></label>
        </div>
        <div class="legend" id="legend"></div>
        <svg id="graph" aria-label="Network graph"></svg>
      </div>
    </div>
  </header>

  <script>
  const REL_URL = 'relationships.csv'; // undirected edges
  const PPL_URL = 'people.csv';        // person info

  const statusR = document.getElementById('statusR');
  const statusP = document.getElementById('statusP');
  const fileR = document.getElementById('fileR');
  const fileP = document.getElementById('fileP');

  // Style panel wiring (updates CSS variables live)
  const root = document.documentElement.style;
  const baseSize = document.getElementById('baseSize');
  const nodeSize = document.getElementById('nodeSize');
  const tipSize  = document.getElementById('tipSize');
  const fontFamily = document.getElementById('fontFamily');
  const bgColor = document.getElementById('bgColor');
  const inkColor = document.getElementById('inkColor');

  function setVar(name, val){ root.setProperty(name, val); }
  baseSize.addEventListener('input', ()=> setVar('--font-size-base', baseSize.value+'px'));
  nodeSize.addEventListener('input', ()=> setVar('--font-size-node', nodeSize.value+'px'));
  tipSize.addEventListener('input',  ()=> { setVar('--font-size-tooltip', tipSize.value+'px'); setVar('--font-size-tooltip-title', (parseInt(tipSize.value,10)+2)+'px'); });
  fontFamily.addEventListener('change', ()=> setVar('--font-family', fontFamily.value));
  bgColor.addEventListener('input', ()=> setVar('--color-bg', bgColor.value));
  inkColor.addEventListener('input', ()=> setVar('--color-ink', inkColor.value));

  let relRows = null, pplRows = null;

  // Try auto-load both CSVs (only works over http://)
  autoLoad(REL_URL, statusR).then(rows => { relRows = rows || relRows; maybeBuild(); });
  autoLoad(PPL_URL, statusP).then(rows => { pplRows = rows || pplRows; maybeBuild(); });

  // File pickers (works with file://)
  fileR.addEventListener('change', e => readFile(e.target.files?.[0], statusR, rows => { relRows = rows; maybeBuild(); }));
  fileP.addEventListener('change', e => readFile(e.target.files?.[0], statusP, rows => { pplRows = rows; maybeBuild(); }));

  async function autoLoad(url, statusEl){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const rows = d3.csvParse(text);
      statusEl.textContent = `Loaded ${url}`;
      return rows;
    }catch(err){
      statusEl.textContent = `Could not auto-load ${url} (${err.message}).`;
      return null;
    }
  }

  function readFile(file, statusEl, cb){
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
      const text = e.target.result;
      const rows = d3.csvParse(text);
      statusEl.textContent = `Loaded ${file.name}`;
      cb(rows);
    };
    r.readAsText(file);
  }

  function maybeBuild(){
    if(!relRows || !pplRows) return; // wait until both available
    buildGraph(relRows, pplRows);
  }

  // ---------------- Graph build ----------------
  function buildGraph(relRows, pplRows){
    // People map
    const people = new Map();
    for(const r of pplRows){
      const id = String(r.person_id ?? r.id ?? r.ID).trim();
      if(!id) continue;
      people.set(id, {
        id,
        name: r.name?.trim() || id,
        role: r.role?.trim() || '',
        affiliation: r.affiliation?.trim() || '',
        email: r.email?.trim() || '',
        notes: r.notes?.trim() || '',
        photo: r.photo?.trim() || ''
      });
    }

    // Nodes & undirected links
    const nodeById = new Map();
    function addNode(id, fallbackName){
      id = String(id).trim();
      if(!nodeById.has(id)){
        const p = people.get(id);
        nodeById.set(id, {
          id,
          name: p?.name || fallbackName || id,
          role: p?.role || '',
          affiliation: p?.affiliation || '',
          email: p?.email || '',
          notes: p?.notes || '',
          photo: p?.photo || ''
        });
      }
      return nodeById.get(id);
    }

    const seen = new Set(), links = [];
    for(const r of relRows){
      const a = addNode(r.person_a_id, r.person_a_name);
      const b = addNode(r.person_b_id, r.person_b_name);
      const key = [Math.min(+a.id, +b.id), Math.max(+a.id, +b.id), r.relationship_id].join('|');
      if(!seen.has(key)){
        links.push({ source: a.id, target: b.id, relationship: r.relationship, relationship_id: r.relationship_id });
        seen.add(key);
      }
    }
    const nodes = Array.from(nodeById.values());

    // --- compute degree for each node (undirected) ---
    const degree = new Map();
    nodes.forEach(n => degree.set(n.id, 0));
    links.forEach(l => {
      degree.set(String(l.source), (degree.get(String(l.source)) || 0) + 1);
      degree.set(String(l.target), (degree.get(String(l.target)) || 0) + 1);
    });
    nodes.forEach(n => n.degree = degree.get(n.id) || 0);

    render(nodes, links);
  }

  function render(nodes, links){
    const svg = d3.select('#graph');
    svg.selectAll('*').remove();

    const { width, height } = svg.node().getBoundingClientRect();
    svg.attr('viewBox', [0,0,width,height]);

    // relationship color scale from token palette
    const relColors = ["var(--rel-1)","var(--rel-2)","var(--rel-3)","var(--rel-4)","var(--rel-5)","var(--rel-6)","var(--rel-7)"];
    const relTypes = [...new Set(links.map(l => l.relationship))];
    const color = d3.scaleOrdinal().domain(relTypes).range(relColors);

    // --- radius scale by degree ---
    const degExtent = d3.extent(nodes, d => d.degree);
    const rMin = 10, rMax = 28;
    const rScale = (degExtent[0] === degExtent[1])
      ? (() => () => (rMin + rMax) / 2)()
      : d3.scaleLinear().domain(degExtent).range([rMin, rMax]);

    // --- node color scale by degree (Viridis) ---
    const [degMin, degMax] = degExtent;
    const nodeColor = (degMin === degMax)
      ? (() => () => '#6b7280')() // neutral fallback when all degrees equal
      : d3.scaleSequential(d3.interpolateViridis).domain([degMin, degMax]); // low→high

    // legend
    const legend = d3.select('#legend').html('');
    relTypes.forEach(t=>{
      const k = legend.append('div').attr('class','key');
      k.append('span').attr('class','swatch').style('background', color(t));
      k.append('span').text(t);
    });

    const linkG = svg.append('g');
    const labelG = svg.append('g');
    const nodeG = svg.append('g');

    const link = linkG.selectAll('line')
      .data(links)
      .join('line')
        .attr('class','link')
        .attr('stroke', d => color(d.relationship));

    const linkLabel = labelG.selectAll('text')
      .data(links)
      .join('text')
        .attr('class','link-label')
        .text(d => d.relationship)
        .style('opacity', 0);

    const node = nodeG.selectAll('g')
      .data(nodes, d=>d.id)
      .join('g')
        .attr('class','node')
        .call(drag(startSim(nodes, links, rScale)));

    node.append('circle')
        .attr('r', d => rScale(d.degree))
        .attr('fill', d => nodeColor(d.degree))
        .attr('stroke', 'var(--color-node-stroke)');

    node.append('text')
        .attr('text-anchor','middle')
        .attr('dy', d => rScale(d.degree) + 16)
        .text(d => d.name ?? d.id);

    // Tooltip
    const tip = d3.select('body').append('div').attr('class','tooltip').style('opacity',0);
    function personHTML(p){
      const email = p.email ? `<div>Email: <a href="mailto:${p.email}">${p.email}</a></div>` : '';
      const roleAff = (p.role||p.affiliation) ? `<div>${[p.role,p.affiliation].filter(Boolean).join(' · ')}</div>` : '';
      const notes = p.notes ? `<div>${p.notes}</div>` : '';
      const photo = p.photo ? `<img src="${p.photo}" alt="${p.name}">` : '';
      const degLine = (typeof p.degree === 'number') ? `<div>Connections: ${p.degree}</div>` : '';
      return `
        <div class="row">
          ${photo}
          <div class="meta">
            <h3>${p.name}</h3>
            ${roleAff}
            ${email}
            ${degLine}
            ${notes}
          </div>
        </div>
      `;
    }

    // interactions
    link.on('mouseover', (e,d)=>{
        linkLabel.filter(l=>l===d).transition().style('opacity',1);
        link.classed('link--dim', l=>l!==d);
        node.classed('node--dim', n=>!(n.id===d.source.id || n.id===d.target.id));
      })
      .on('mouseout', ()=>{
        linkLabel.transition().style('opacity',0);
        link.classed('link--dim', false);
        node.classed('node--dim', false);
      });

    node.on('mousemove', (e,d)=>{
        tip.style('opacity',1)
           .html(personHTML(d))
           .style('left', (e.pageX + 12) + 'px')
           .style('top',  (e.pageY - 12) + 'px');
        linkLabel.transition().style('opacity', l => (l.source.id===d.id || l.target.id===d.id) ? 1 : 0);
        node.classed('node--dim', n=>n.id!==d.id);
        link.classed('link--dim', l=>!(l.source.id===d.id || l.target.id===d.id));
      })
      .on('mouseout', ()=>{
        tip.style('opacity',0);
        linkLabel.transition().style('opacity',0);
        node.classed('node--dim', false);
        link.classed('link--dim', false);
      })
      .on('click', (e,d)=>{ d.fx = d.fx == null ? d.x : null; d.fy = d.fy == null ? d.y : null; });

    function startSim(nodes, links, rScale){
      const sim = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d=>d.id).distance(160).strength(0.8))
        .force('charge', d3.forceManyBody().strength(-350))
        .force('center', d3.forceCenter(width/2, height/2))
        .force('collide', d3.forceCollide(d => rScale(d.degree) + 6))
        .on('tick', ticked);
      return sim;
    }

    function ticked(){
      link
        .attr('x1', d=>d.source.x).attr('y1', d=>d.source.y)
        .attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);

      linkLabel
        .attr('x', d => (d.source.x + d.target.x) / 2)
        .attr('y', d => (d.source.y + d.target.y) / 2);

      node.attr('transform', d => `translate(${d.x},${d.y})`);
    }

    function drag(sim){
      function start(e,d){ if(!e.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
      function dragged(e,d){ d.fx=e.x; d.fy=e.y; }
      function end(e,d){ if(!e.active) sim.alphaTarget(0); }
      return d3.drag().on('start', start).on('drag', dragged).on('end', end);
    }

    // keep viewBox responsive
    window.onresize = () => {
      const { width, height } = svg.node().getBoundingClientRect();
      svg.attr('viewBox', [0,0,width,height]);
    };
  }
  </script>
</body>
</html>
